// ==UserScript==
// @name         自动点击下一个任务
// @namespace    http://tampermonkey.net/
// @version      1.3
// @description  任务完成后，跨层级查找“下一个”按钮并点击
// @match        *://*.chaoxing.com/*
// @match        *://*.edu.cn/*
// @match        *://*/*
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    // 配置项
    const TARGET_SELECTOR = 'div.ans-job-icon.ans-job-icon-clear[aria-label="任务点已完成"]';
    // 优先使用类名匹配（更准），如果失败再退化为文字匹配
    const BTN_SELECTOR_CLASS = '.xhandle.next'; 
    const CHECK_INTERVAL = 2000; 

    // --- 核心工具：在指定文档中查找并点击 ---
    function tryClickInDocument(doc, scopeName) {
        if (!doc) return false;

        // 1. 优先尝试通过精确的 class 查找 (根据你提供的 HTML)
        let btn = doc.querySelector(BTN_SELECTOR_CLASS);
        
        // 2. 如果 class 没找到，尝试通过文字查找所有的 A 标签
        if (!btn) {
            const links = doc.querySelectorAll('a');
            for (let i = 0; i < links.length; i++) {
                const text = links[i].textContent ? links[i].textContent.trim() : "";
                if (text.includes("下一个")) {
                    btn = links[i];
                    break;
                }
            }
        }

        if (btn) {
            console.info(`[任务检测] 在 [${scopeName}] 中找到了按钮，正在点击...`);
            btn.click();
            
            // 双重保险：有时候 click() 不生效，尝试原生事件
            // try {
            //     btn.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true, view: window }));
            // } catch(e) {}
            
            return true;
        }
        return false;
    }

    // --- 查找按钮的主逻辑 (支持跨 Frame) ---
    function findAndClickGlobal() {
        // 1. 搜寻当前页面 (Current Frame)
        if (tryClickInDocument(document, '当前页面')) return true;

        // 2. 搜寻父页面 (Parent Frame)
        try {
            if (window.parent && window.parent.document !== document) {
                if (tryClickInDocument(window.parent.document, '父页面')) return true;
            }
        } catch (e) {
            // 跨域限制，无法访问父页面，忽略
        }

        // 3. 搜寻顶层页面 (Top Frame)
        try {
            if (window.top && window.top.document !== document) {
                if (tryClickInDocument(window.top.document, '顶层页面')) return true;
            }
        } catch (e) {
            // 跨域限制，忽略
        }

        return false;
    }

    // --- 任务完成状态检测 ---
    function isTaskFinished() {
        // 1. 当前页面查找
        if (document.querySelector(TARGET_SELECTOR)) return true;

        // 2. 遍历子 iframe 查找
        const frames = document.querySelectorAll('iframe');
        for (let i = 0; i < frames.length; i++) {
            try {
                const frameDoc = frames[i].contentDocument || frames[i].contentWindow.document;
                if (frameDoc && frameDoc.querySelector(TARGET_SELECTOR)) {
                    return true;
                }
            } catch (e) {}
        }
        return false;
    }

    // --- 主循环 ---
    function checkAndClick() {
        // 检测是否有完成标记
        if (isTaskFinished()) {
            // 尝试全范围查找按钮
            const success = findAndClickGlobal();
            if (!success) {
                // 为了防止刷屏，只在找不到的时候偶尔报警告，或者可以注释掉
                console.warn('[任务检测] 状态：已完成，但未在 当前/父级/顶级 页面找到“下一个”按钮。');
            }
        }
    }

    console.info('[任务检测] 脚本已启动 (跨层级搜索版)');
    setInterval(checkAndClick, CHECK_INTERVAL);
})();
